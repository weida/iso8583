local iso8583 = require("iso8583")

--local iso8583_str = "0100202000000080801B350000000453313331303532303231353600183030303030303030303030303030303030300002009A002031313130303031393030303039363330303033353242443430443338"
local iso8583_str = "30313030F23C2481A8E0980000000000000001003136343237363535353535353535353535353030303030303030303030303037373730303032313031313431323031313431323031333138343430373031313930323634333930313032303631323334353630363132333435363337343237363535353535353535353535353D313233343536373839303132333435363738393039383736353433323130303130303030303332313132303030303030303030303033342020202020202020202020202020202020202020202020202020202020202054657374207465787436"
--local iso8583_str="30313030f23a44c18ce090100000004010000020313636323236333039383130303031313233323030303030303030303030303030303031303432393133323432323033303436353131313435393033333130333331202020203031323036303030333235303034303230303130323432313039313336353231393630373030353139353538333034313130303730313130313233202020202020202020202020202020202020202020202020202020202020202020202020202020203135363030303030303030303134303030303030303030363030303030313030303931333635313231393130323432313235302020202020202020303230302020202020202031313030303030303030303030303432202020202020202020202020202020202020202020202020202020202020303033303436353030303030"

local function to_bin(str)
    return ({str:gsub("..", function(x) return string.char(tonumber(x, 16)) end)})[1]
end

local function to_hex(str)
    return ({str:gsub(".", function(c) return string.format("%02X", c:byte(1)) end)})[1]
end

print(iso8583_str)


iso8583_str = to_bin(iso8583_str)

local parser, err = iso8583.new()

local msg, err = parser:Unpack(iso8583_str, 33)

print (err)


local key = {7, 11, 32, 33}

for k, v in pairs(msg) do
	print(k,':', v)
end

print('----------------------')
print(msg[7])
print(msg[11])
print(msg[32])
print(msg[33])
key = msg[7] .. msg[11] .. msg[32] .. msg[33]
print(key)
print('----------------------')

local packed_str, err = parser:Pack(msg)

if not packed_str then
	print(err)
	return
end

local packed_str_hex = to_hex(packed_str)

print(packed_str_hex)
